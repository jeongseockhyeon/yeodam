<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
<!--    <meta name="_csrf" th:content="${_csrf.token}"/>-->
<!--    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>-->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .cart-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
        }
        .quantity-control {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }
        .total-price {
            text-align: right;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .item-checkbox {
            margin-right: 15px;
        }
    </style>
</head>
<body>
<div class="cart-container">
    <h1 class="mb-4">장바구니</h1>

    <!-- 장바구니 목록 -->
    <div id="cartItems">
        <!-- 서버 장바구니 -->
        <div th:if="${!anonymous}">
            <div th:each="cart : ${carts}" class="cart-item">
                <input type="checkbox" class="item-checkbox" th:value="${cart.id}">
                <div class="item-info">
                    <h3 th:text="${cart.item.itemName}">상품명</h3>
                    <p th:text="${cart.price}">가격</p>
                </div>
                <div class="quantity-control" th:if="${!cart.reservation}">
                    <button class="quantity-btn" th:onclick="'updateCartCount(' + ${cart.id} + ', -1)'">-</button>
                    <span th:text="${cart.count}" th:data-cart-id="${cart.id}">수량</span>
                    <button class="quantity-btn" th:onclick="'updateCartCount(' + ${cart.id} + ', 1)'">+</button>
                </div>
                <div th:if="${cart.reservation}" th:text="'예약상품'" class="badge bg-secondary"></div>
                <button class="btn btn-danger btn-sm ms-3" th:onclick="'removeCart(' + ${cart.id} + ')'">삭제</button>
            </div>
        </div>
        <!-- 로컬 스토리지 장바구니 -->
        <div th:if="${anonymous}" id="localCartItems"></div>
    </div>

    <!-- 총 금액 -->
    <div class="total-price mt-4">
        총 금액: <span id="totalPrice" th:text="${totalPrice?.totalPrice ?: 0}">0</span>원
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const isLoggedIn = ![[${anonymous}]];
<!--    const csrfToken = document.querySelector("meta[name='_csrf']").content; -->
<!--    const csrfHeader = document.querySelector("meta[name='_csrf_header']").content; -->

    // 로컬 스토리지 장바구니 초기화
    function initializeLocalCart() {
        if (!isLoggedIn) {
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            renderLocalCart(cartItems);
        }
    }

    // 로컬 스토리지 장바구니 렌더링
    function renderLocalCart(items) {
        const container = document.getElementById('localCartItems');
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div class="empty-cart">장바구니가 비어있습니다.</div>';
            return;
        }

        let total = 0;
        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'cart-item';
            itemElement.innerHTML = `
                        <input type="checkbox" class="item-checkbox" value="${item.itemId}">
                        <div class="item-info">
                            <h3>${item.itemName}</h3>
                            <p>${item.price * item.count}원</p>
                        </div>
                        ${!item.reservation ? `
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateLocalCount(${item.itemId}, -1)">-</button>
                            <span>${item.count}</span>
                            <button class="quantity-btn" onclick="updateLocalCount(${item.itemId}, 1)">+</button>
                        </div>
                        ` : '<div class="badge bg-secondary">예약상품</div>'}
                        <button class="btn btn-danger btn-sm ms-3" onclick="removeLocalItem(${item.itemId})">삭제</button>
                    `;
            container.appendChild(itemElement);
            total += item.price * item.count;
        });

        document.getElementById('totalPrice').textContent = total;
    }

    // DB 수량 업데이트
    async function updateCartCount(cartId, change) {
        try {
            const currentCount = document.querySelector(`[data-cart-id="${cartId}"]`).textContent;
            const newCount = parseInt(currentCount) + change;

            if (newCount < 1) return;

            const response = await fetch(`/api/carts/${cartId}/count`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },  // 콤마 추가
                body: JSON.stringify({ count: newCount })
            });

            if (!response.ok) throw new Error('수량 업데이트 실패');

            location.reload();
        } catch (error) {
            console.error('수량 업데이트 실패:', error);
            alert('수량 변경에 실패했습니다.');
        }
    }

    // 로컬 스토리지 수량 업데이트
    function updateLocalCount(itemId, change) {
        const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        const itemIndex = cartItems.findIndex(item => item.itemId === itemId);

        if (itemIndex !== -1) {
            const newCount = cartItems[itemIndex].count + change;
            if (newCount < 1) return;

            cartItems[itemIndex].count = newCount;
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            renderLocalCart(cartItems);
        }
    }

    // DB 아이템 삭제
    async function removeCart(cartId) {
        try {
            const response = await fetch(`/api/carts/${cartId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('삭제 실패');

            location.reload();
        } catch (error) {
            console.error('삭제 실패:', error);
            alert('상품 삭제에 실패했습니다.');
        }
    }

    // 로컬 스토리지 상품 삭제
    function removeLocalItem(itemId) {
        const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        const updatedItems = cartItems.filter(item => item.itemId !== itemId);
        localStorage.setItem('cartItems', JSON.stringify(updatedItems));
        renderLocalCart(updatedItems);
    }

    // 로그인 시 로컬 스토리지 장바구니 동기화
    async function syncLocalCartToServer() {
        if (isLoggedIn) {
            const localCart = JSON.parse(localStorage.getItem('cartItems')) || [];
            if (localCart.length > 0) {
                try {
                    await fetch('/api/carts/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(localCart)
                    });
                    localStorage.removeItem('cartItems');
                    location.reload();
                } catch (error) {
                    console.error('장바구니 동기화 실패:', error);
                }
            }
        }
    }

    // 체크된 상품 가격 계산
    function calculateSelectedPrice() {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        const cartIds = Array.from(checkedItems).map(item => item.value);

        if (cartIds.length > 0) {
            if (isLoggedIn) {
                fetch('/carts/selected-price?cartIds=' + cartIds.join(','))
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('totalPrice').textContent = data.totalPrice;
                    });
            } else {
                const localCart = JSON.parse(localStorage.getItem('cartItems')) || [];
                const total = localCart
                    .filter(item => cartIds.includes(item.itemId.toString()))
                    .reduce((sum, item) => sum + (item.price * item.count), 0);
                document.getElementById('totalPrice').textContent = total;
            }
        }
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
        if (!isLoggedIn) {
            initializeLocalCart();
        } else {
            syncLocalCartToServer();
        }

        // 체크박스 이벤트 리스너
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', calculateSelectedPrice);
        });
    });
    /*]]>*/
</script>
</body>
</html>
